# 此文件为前端配置，后端的配置在对应服务器维护 http://wiki.ricequant.com/pages/viewpage.action?pageId=52233128
# 此文件由git跟踪，http://git.ricequant.com/projects/NODE/repos/ng/browse/nginx.conf，pr后自动生效，手动修改会被覆盖
# 
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 65535;
    accept_mutex on;
    multi_accept on;
    use epoll;
}

http {
    include       /etc/nginx/mime.types;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log main;
    rewrite_log on;

    charset utf-8;

    sendfile            on;
    tcp_nopush          on;
    reset_timedout_connection on;
    client_max_body_size 64M;

    ssl_certificate     /etc/ssl/ricequant/server.crt;
    ssl_certificate_key /etc/ssl/ricequant/server.key;
    ssl_prefer_server_ciphers  on;
    ssl_session_cache    shared:SSL:10m;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/csv font/woff font/woff2 application/javascript application/json application/pdf;
    
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream online {
	    server www.ricequant.com:443;
    }

    upstream uat {
    	server 192.168.10.41:38080;
        server 192.168.10.42:38080;
    	server 192.168.10.43:38080;
    }

    upstream st-quant {
        server 192.168.10.91:18085;
    }

    upstream st-ams {
        server 192.168.10.79:18085;
    }

    upstream st-fof {
        server 192.168.10.80:18085;
    }

    upstream st-bond {
        server 192.168.10.78:10000;
    }
    
    server {
        listen 80;
        server_name anka.ricequant.com;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen              443 ssl http2;
        server_name         anka.ricequant.com;

        include includes/csp.conf;
    
        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/uat/anka;
            try_files $uri $uri/ /welcome/index.html;
            include includes/http_common_headers.conf;
        }

        location /dashboard {
            alias /static/uat/ardan;
            try_files $uri $uri/ /dashboard/index.html;
            include includes/http_common_headers.conf;
        }

        location /ams {
            if ($http_user_agent ~* "android|iphone") {
                return 301 https://m-anka.ricequant.com$request_uri;
            }
            alias /static/uat/ams;
            try_files $uri $uri/ /ams/index.html;
            include includes/http_common_headers.conf;
            if ($uri ~ 'csv$|pdf$') {
                add_header Content-Disposition 'attachment;';
            }
        }

        location /quant {
            alias /static/uat/quant;
            try_files $uri $uri/ /quant/index.html;
            include includes/http_common_headers.conf;
        }

        location /factor {
            alias /static/uat/factor;
            try_files $uri $uri/ /factor/index.html;
            include includes/http_common_headers.conf;
        }

        location /site {
            alias /static/uat/site;
            try_files $uri $uri/ /site/index.html;
            include includes/http_common_headers.conf;
        }

        location /fof {
            alias /static/uat/fof;
            try_files $uri $uri/ /fof/index.html;
            include includes/http_common_headers.conf;
        }

        location /bond {
            alias /static/uat/bond;
            try_files $uri $uri/ /bond/index.html;
            include includes/http_common_headers.conf;
        }

        location /doc {
            alias /static/uat/koshka;
            try_files $uri $uri/ /doc/404.html;
            include includes/http_common_headers.conf;
        }

        location /doc/rqalpha-plus/api {
            alias /static/uat/sphinx/rqalpha-plus;
        }

        location /doc/rqoptimizer/api {
            alias /static/uat/sphinx/rqoptimizer;
        }
        
        location /vendor {
            root /static/uat/;
            add_header Cache-Control max-age=43200;
        }

        location /notification {
		    return 302 /quant$request_uri;
	    }

        location /courses {
		    return 302 https://blog.ricequant.com;
	    }

        location /site/courses {
		    return 302 https://blog.ricequant.com;
	    }

        location /purchase {
		    return 302 /welcome$request_uri;
	    }

        location /api {
            proxy_pass http://uat;
            proxy_set_header Host anka.ricequant.com;
            add_header Cache-Control 'no-cache';
        }

        location ~ ^/(notifier|api/notifier|research|pyls) {
            proxy_pass http://uat;
            proxy_set_header Origin https://anka.ricequant.com;
            proxy_set_header Host anka.ricequant.com;
            proxy_set_header upgrade $http_upgrade;
            proxy_set_header connection $connection_upgrade;
        }

        location /img/avatar {
            proxy_pass http://uat;
        }

    }

    server {
        listen              443 ssl http2;
        server_name         m-anka.ricequant.com;

        ssl_certificate     /etc/ssl/ricequant-mobile/server.crt;
        ssl_certificate_key /etc/ssl/ricequant-mobile/server.key;

        include includes/csp-m.conf;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/uat/anka-mobile;
            try_files $uri $uri/ /welcome/index.html;
            include includes/http_common_headers.conf;
        }

        location /ams {
            if ($http_user_agent !~* "android|iphone") {
                return 301 https://anka.ricequant.com$request_uri;
            }
            alias /static/uat/ams-mobile;
            try_files $uri $uri/ /ams/index.html;
            include includes/http_common_headers.conf;
        }

        location /api {
            proxy_pass http://uat;
            proxy_set_header Host anka.ricequant.com;
            add_header Cache-Control 'no-cache';
        }
    }

    server {
        listen  8084 ssl http2;
        server_name anka.ricequant.com;

         location / {
            return 302 /fof/;
        }

        location /fof {
            alias /static/cmb-fof-dev/fof;
            try_files $uri $uri/ /fof/index.html;
        }

        location /ams {
            alias /static/cmb-fof-dev/ams;
            try_files $uri $uri/ /ams/index.html;
        }

        location /api {
            proxy_pass http://192.168.10.51;
            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  http;
            proxy_set_header  referer "$scheme://$host:$server_port";
        }
    }

    server {
        listen              8085 ssl http2;
        server_name         anka.ricequant.com;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/st/anka;
            try_files $uri $uri/ /welcome/index.html;
        }

        location /dashboard {
            alias /static/st/ardan;
            try_files $uri $uri/ /dashboard/index.html;
        }

        location /ams {
            if ($http_user_agent ~* "android|iphone") {
                return 301 https://m-anka.ricequant.com:8085$request_uri;
            }
            alias /static/st/ams;
            try_files $uri $uri/ /ams/index.html;
            if ($uri ~ 'csv$|pdf$') {
                add_header Content-Disposition 'attachment;';
            }
        }

        location /fof {
            alias /static/st/fof;
            try_files $uri $uri/ /fof/index.html;
        }

        location /bond {
            alias /static/st/bond;
            try_files $uri $uri/ /bond/index.html;
        }

        location /quant {
            alias /static/st/quant;
            try_files $uri $uri/ /quant/index.html;
        }

	    location /factor {
            alias /static/st/factor;
            try_files $uri $uri/ /factor/index.html;
        }

        location /site {
            alias /static/st/site;
            try_files $uri $uri/ /site/index.html;
            add_header Access-Control-Allow-Origin *;
        }

        location /doc {
            alias /static/st/koshka;
            try_files $uri $uri/ /doc/404.html;
        }

        location /rqthemes {
            alias /static/st/rqthemes;
            try_files $uri $uri/ /rqthemes/index.html;
        }

        location /report-demo {
            alias /static/st/report-demo;
            try_files $uri $uri/ /report-demo/index.html;
        }

        location /crystal {
            alias /static/st/crystal;
            try_files $uri $uri/ /crystal/index.html;
        }

        location /notification {
		    return 302 /quant$request_uri;
	    }

        location /courses {
		    return 302 https://blog.ricequant.com;
	    }

        location /site/courses {
		    return 302 https://blog.ricequant.com;
	    }

        location /purchase {
		    return 302 /welcome$request_uri;
	    }

        location /api {
            proxy_pass http://st-quant;
            add_header Cache-Control 'no-cache';
        }

        location /api/rqams {
            proxy_pass http://st-ams;
            add_header Cache-Control 'no-cache';
        }

        location /api/fof {
            proxy_pass http://st-fof;
            add_header Cache-Control 'no-cache';
        }

        location /api/pool {
            proxy_pass http://st-fof;
            add_header Cache-Control 'no-cache';
        }

        location /api/legend {
            proxy_pass http://st-bond;
            add_header Cache-Control 'no-cache';
        }

        location ~ ^/(notifier|api/notifier|research|pyls) {
            proxy_pass http://st-quant;
            proxy_set_header upgrade $http_upgrade;
            proxy_set_header connection $connection_upgrade;
        }

        location /img/avatar {
            proxy_pass http://st-quant;
        }
    }

    server {
        listen              8085 ssl http2;
        server_name         m-anka.ricequant.com;

        ssl_certificate     /etc/ssl/ricequant-mobile/server.crt;
        ssl_certificate_key /etc/ssl/ricequant-mobile/server.key;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/st/anka-mobile;
            try_files $uri $uri/ /welcome/index.html;
        }

        location /ams {
            if ($http_user_agent !~* "android|iphone") {
                return 301 https://anka.ricequant.com:8085$request_uri;
            }
            alias /static/st/ams-mobile;
            try_files $uri $uri/ /ams/index.html;
        }

        location /api {
            proxy_pass https://localhost:8085;
            add_header Cache-Control 'no-cache';
        }
    }

    server {
        listen 443 ssl http2;
        server_name www.ricequant.com;
        location / {
            proxy_pass https://localhost:8085;
        }
    }

}
