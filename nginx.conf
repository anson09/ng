# 此文件为前端配置，后端的配置在对应服务器维护 http://wiki.ricequant.com/pages/viewpage.action?pageId=52233128
# 此文件由git跟踪，http://git.ricequant.com/projects/NODE/repos/ng/browse/nginx.conf，pr后自动生效，手动修改会被覆盖
# 
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 65535;
    accept_mutex on;
    multi_accept on;
    use epoll;
}

http {
    include       /etc/nginx/mime.types;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log main;
    rewrite_log on;

    charset utf-8;

    sendfile            on;
    tcp_nopush          on;
    reset_timedout_connection on;
    client_max_body_size 64M;

    ssl_certificate     /etc/ssl/ricequant/server.crt;
    ssl_certificate_key /etc/ssl/ricequant/server.key;
    ssl_prefer_server_ciphers  on;
    ssl_session_cache    shared:SSL:10m;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/csv font/woff font/woff2 application/javascript application/json application/pdf;
    
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream online {
	    server www.ricequant.com:443;
    }

    upstream uat {
        server 192.168.10.42:18080;
    }

    upstream st-quant {
        server 192.168.10.81:18085;
    }

    upstream st-fof {
        server 192.168.10.80:18085;
    }

    upstream st-bond {
        server 192.168.10.78:10000;
    }
    
    upstream k {
        server 192.168.10.250;
    }

    server {
        listen 80;
        server_name anka.ricequant.com;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen              443 ssl http2;
        server_name         anka.ricequant.com;

        include includes/csp.conf;
    
        location / {
            return 302 /welcome/;
        }

        location /crystal {
            alias /static/crystal;
            try_files $uri $uri/ /crystal/index.html;
            include includes/http_common_headers.conf;
        }

        location /welcome {
            alias /static/anka;
            try_files $uri $uri/ /welcome/index.html;
            include includes/http_common_headers.conf;
        }

        location /dashboard {
            alias /static/ardan;
            try_files $uri $uri/ /dashboard/index.html;
            include includes/http_common_headers.conf;
        }

        location /ams {
            if ($http_user_agent ~* "android|iphone") {
                return 301 https://m-anka.ricequant.com/$request_uri;
            }
            alias /static/ams;
            try_files $uri $uri/ /ams/index.html;
            include includes/http_common_headers.conf;
            if ($uri ~ 'csv$|pdf$') {
                add_header Content-Disposition 'attachment;';
            }
        }

        location /quant {
            alias /static/quant;
            try_files $uri $uri/ /quant/index.html;
            include includes/http_common_headers.conf;
        }

        location /air {
            alias /static/air;
            try_files $uri $uri/ /air/index.html;
            include includes/http_common_headers.conf;
        }

        location /factor {
            alias /static/factor;
            try_files $uri $uri/ /factor/index.html;
            include includes/http_common_headers.conf;
        }

        location /wizard {
            alias /static/wizard;
            try_files $uri $uri/ /wizard/index.html;
            include includes/http_common_headers.conf;

        }

        location /site {
            alias /static/site;
            try_files $uri $uri/ /site/index.html;
            include includes/http_common_headers.conf;
        }

        location /doc {
            alias /static/koshka;
            try_files $uri $uri/ /doc/404.html;
            include includes/http_common_headers.conf;
        }

        location /doc/rqalpha-plus/api {
            alias /static/sphinx/rqalpha-plus;
        }

        location /doc/rqoptimizer/api {
            alias /static/sphinx/rqoptimizer;
        }
        
        location /vendor {
            root /static/;
            add_header Cache-Control max-age=43200;
        }

        location ~ ^/(scrafts|tournament|courses|notification) {
		    return 302 /site$request_uri;
	    }

        location /purchase {
		    return 302 /welcome$request_uri;
	    }

        location ~ ^/(api|pudge) {
            proxy_pass https://online;
            proxy_set_header Host www.ricequant.com;
        }

        location ~ ^/(notifier|research|community|pyls) {
            proxy_pass https://online;
            proxy_set_header Origin https://www.ricequant.com;
            proxy_set_header Host www.ricequant.com;
            proxy_set_header upgrade $http_upgrade;
            proxy_set_header connection $connection_upgrade;
        }

    }

    server {
        listen              443 ssl http2;
        server_name         m-anka.ricequant.com;

        include includes/csp-m.conf;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/anka-mobile;
            try_files $uri $uri/ /welcome/index.html;
            include includes/http_common_headers.conf;
        }

        location /ams {
            if ($http_user_agent !~* "android|iphone") {
                return 301 https://anka.ricequant.com/$request_uri;
            }
            alias /static/ams-mobile;
            try_files $uri $uri/ /ams/index.html;
            include includes/http_common_headers.conf;
        }

        location /api {
            proxy_pass https://online;
            proxy_set_header Host www.ricequant.com;
        }
    }

    server {
        listen              8080 ssl http2;
        server_name         anka.ricequant.com;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/naga/anka;
            try_files $uri $uri/ /welcome/index.html;
        }

        location /dashboard {
            alias /static/naga/ardan;
            try_files $uri $uri/ /dashboard/index.html;
        }

        location /ams {
            if ($http_user_agent ~* "android|iphone") {
                return 301 https://m-anka.ricequant.com:8080/$request_uri;
            }
            alias /static/naga/ams;
            try_files $uri $uri/ /ams/index.html;
        }

        location /bond {
            alias /static/naga/bond;
            try_files $uri $uri/ /bond/index.html;
        }

        location /quant {
            alias /static/naga/quant;
            try_files $uri $uri/ /quant/index.html;
        }

	    location /wizard {
            alias /static/naga/wizard;
            try_files $uri $uri/ /wizard/index.html;
        }
	    location /factor {
            alias /static/naga/factor;
            try_files $uri $uri/ /factor/index.html;
        }

        location /site {
            alias /static/naga/site;
            try_files $uri $uri/ /site/index.html;
        }

        location ~ ^/(scrafts|tournament|courses|notification) {
		    return 302 /site$request_uri;
	    }

        location /purchase {
            return 302 /welcome$request_uri;
        }

        location ~ ^/(api|pudge) {
            proxy_pass http://uat;
        }

        location ~ ^/(notifier|research|community|pyls) {
            proxy_pass http://uat;
            proxy_set_header upgrade $http_upgrade;
            proxy_set_header connection $connection_upgrade;
        }

    }

    server {
        listen              8080 ssl http2;
        server_name         m-anka.ricequant.com;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/naga/anka-mobile;
            try_files $uri $uri/ /welcome/index.html;
            include includes/http_common_headers.conf;
        }

        location /ams {
            if ($http_user_agent !~* "android|iphone") {
                return 301 https://anka.ricequant.com:8080/$request_uri;
            }

            alias /static/naga/ams-mobile;
            try_files $uri $uri/ /ams/index.html;
            include includes/http_common_headers.conf;
        }

        location /api {
            proxy_pass http://uat;
        }
    }

    server {
        listen              8081 ssl http2;
        server_name         anka.ricequant.com;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/k/anka;
            try_files $uri $uri/ /welcome/index.html;
        }

        location /dashboard {
            alias /static/k/ardan;
            try_files $uri $uri/ /dashboard/index.html;
        }

        location /ams {
            alias /static/k/ams;
            try_files $uri $uri/ /ams/index.html;
        }

        location /bond {
            alias /static/k/bond;
            try_files $uri $uri/ /bond/index.html;
        }

        location /quant {
            alias /static/k/quant;
            try_files $uri $uri/ /quant/index.html;
        }

	    location /wizard {
            alias /static/k/wizard;
            try_files $uri $uri/ /wizard/index.html;
        }

	    location /factor {
            alias /static/k/factor;
            try_files $uri $uri/ /factor/index.html;
        }

        location /site {
            alias /static/k/site;
            try_files $uri $uri/ /site/index.html;
            add_header Access-Control-Allow-Origin *;
        }
        
        location ~ ^/(scrafts|tournament|courses|notification) {
		    return 302 /site$request_uri;
	    }

        location /purchase {
            return 302 /welcome$request_uri;
        }

        location ~ ^/(api|pudge) {
            proxy_pass http://k;
        }

        location ~ ^/(notifier|research|community|pyls) {
            proxy_pass http://k;
            proxy_set_header upgrade $http_upgrade;
            proxy_set_header connection $connection_upgrade;
        }
    }

    server {
        listen 443 ssl http2;
        server_name www.ricequant.com;
        location / {
            proxy_pass https://localhost:8081;
        }
    }

    server {
        listen  8084 ssl http2;
        server_name anka.ricequant.com;

         location / {
            return 302 /fof/;
        }

        location /fof {
            alias /static/cmb-fof-dev/fof;
            try_files $uri $uri/ /fof/index.html;
        }

        location /ams {
            alias /static/cmb-fof-dev/ams;
            try_files $uri $uri/ /ams/index.html;
        }

        location /chart-demo {
            alias /static/chart-demo;
            try_files $uri $uri/ /chart-demo/index.html;
        }
        
        location /api {
            proxy_pass http://192.168.10.51;
            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  http;
            proxy_set_header  referer "$scheme://$host:$server_port";
        }
    }

    server {
        listen              8085 ssl http2;
        server_name         anka.ricequant.com;

        location / {
            return 302 /welcome/;
        }

        location /welcome {
            alias /static/ws2/anka;
            try_files $uri $uri/ /welcome/index.html;
        }

        location /dashboard {
            alias /static/ws2/ardan;
            try_files $uri $uri/ /dashboard/index.html;
        }

        location /ams {
            alias /static/ws2/ams;
            try_files $uri $uri/ /ams/index.html;
        }

        location /fof {
            alias /static/ws2/fof;
            try_files $uri $uri/ /fof/index.html;
        }

        location /bond {
            alias /static/ws2/bond;
            try_files $uri $uri/ /bond/index.html;
        }

        location /quant {
            alias /static/ws2/quant;
            try_files $uri $uri/ /quant/index.html;
        }

	    location /wizard {
            alias /static/ws2/wizard;
            try_files $uri $uri/ /wizard/index.html;
        }

	    location /factor {
            alias /static/ws2/factor;
            try_files $uri $uri/ /factor/index.html;
        }

        location /site {
            alias /static/ws2/site;
            try_files $uri $uri/ /site/index.html;
            add_header Access-Control-Allow-Origin *;
        }

        location /doc {
            alias /static/ws2/doc;
            try_files $uri $uri/ /doc/404.html;
        }

        location ~ ^/(scrafts|tournament|courses|notification) {
		    return 302 /site$request_uri;
	    }

        location /purchase {
            return 302 /welcome$request_uri;
        }

        location ^~ /api/fof {
            proxy_pass http://st-fof;
        }

        location ^~ /api/bond {
            proxy_pass http://st-bond;
        }

        location ~ ^/(api|pudge) {
            proxy_pass http://st-quant;
        }

        location ~ ^/(notifier|research|community|pyls) {
            proxy_pass http://st-quant;
            proxy_set_header upgrade $http_upgrade;
            proxy_set_header connection $connection_upgrade;
        }
    }

}
